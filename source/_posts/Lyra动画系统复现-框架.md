---
title: Lyra动画系统-框架
date: 2023-12-20
index_img: "/img/bg/Lyra.jpg"
tags: [计算机角色动画]
categories: 
   -[笔记]
---

<!-- more -->

[【UE】Lyra动画系统拆解（框架篇）](https://zhuanlan.zhihu.com/p/628247619)

# Lyra动画系统框架

![](/article_img/2023-12-20-16-32-23.png)

Lyra的动画系统框架很值得学习，他的核心思想就是解耦，不断地解耦。

**主动画蓝图（ABP_Mannequin_Base）** 用来实现最基础的状态机，其中每个状态都 **没有具体实现**，而是直接交给一个动画图层实现，这些动画层又被全部抽象出来，放在一个 **动画层接口（ALI_ItemAnimLayers）** 中，主动画蓝图继承这个动画层接口，但是也不实现这些动画层，把实现的工作交给另一个动画蓝图；**把基础状态机和每个具体状态的实现解耦**；
![](/article_img/2023-12-21-15-09-40.png) | ![](/article_img/2023-12-21-15-10-02.png)
---|---

**状态实现蓝图（ABP_ItemAnimLayersBase）** 也继承自动画层接口，用来实现每个动画层，但是实现时也不会直接把动画序列放进去，而是用序列播放器搭配动画序列变量，完成实现逻辑；**把播放的动画序列和状态的实现解耦**；
![](/article_img/2023-12-21-15-18-53.png)

**资产配置蓝图（ABP_PistolAnimLayers）** 继承自状态实现蓝图，负责把对应的动画序列填入状态实现蓝图的对应变量中：
![](/article_img/2023-12-21-15-22-24.png)

最后，使用 **关联动画类图层（LinkAnimClassLayer）** 节点，把要要播放的资产配置蓝图和主动画蓝图关联即可；
![](/article_img/2023-12-21-15-28-57.png)

Lyra这样设计动画系统可以非常方便的完成一个新状态机的制作，比如有使用手枪和使用步枪的两套动画，他们有相同的动画状态机和状态实现，只需要不同的资产配置蓝图用来把两套动画序列配置好即可，在切换武器时变更动画也非常方便。

# 多线程更新动画（Blueprint Thread Safe Update Functions）

Lyra把原本放在 **事件图标（EventGraph）** 也就是**游戏线程**中执行的逻辑（比如获取角色的速度旋转等信息），放到了 **工作线程** 中执行，可以获得更好的性能。

但是这样做有个点要注意，由于将数据更新放在工作线程中，许多变量和函数无法直接调用（只有用BlueprintThreadSafe修饰的才可以），因此需要使用 **PropertyAccess** 来访问变量：
![](/article_img/2023-12-21-15-37-08.png)

为此，我们需要定义一系列函数来更新变量，这些函数需要勾选 **线程安全** 才能在**BlueprintThreadSafeUpdateAnimation**中被调用：
![](/article_img/2023-12-21-15-40-32.png)